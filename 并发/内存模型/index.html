<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>内存模型 | GOFamily - go 程序员宝典</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" type="image/x-icon" href="/GOFamily/favicon.ico">
    <meta name="description" content="🔥 go 程序员宝典，包含了：算法，数据库，网络操作系统，分布式，系统设计等一揽子知识体系">
    
    <link rel="preload" href="/GOFamily/assets/css/0.styles.93ee3edc.css" as="style"><link rel="preload" href="/GOFamily/assets/js/app.6dac5fbf.js" as="script"><link rel="preload" href="/GOFamily/assets/js/2.5c331e53.js" as="script"><link rel="preload" href="/GOFamily/assets/js/108.339b1d12.js" as="script"><link rel="prefetch" href="/GOFamily/assets/js/10.993cf521.js"><link rel="prefetch" href="/GOFamily/assets/js/100.8a13422e.js"><link rel="prefetch" href="/GOFamily/assets/js/101.56e8a149.js"><link rel="prefetch" href="/GOFamily/assets/js/102.0befb22b.js"><link rel="prefetch" href="/GOFamily/assets/js/103.318b2dd9.js"><link rel="prefetch" href="/GOFamily/assets/js/104.5190ec56.js"><link rel="prefetch" href="/GOFamily/assets/js/105.27135b71.js"><link rel="prefetch" href="/GOFamily/assets/js/106.ee0a923b.js"><link rel="prefetch" href="/GOFamily/assets/js/107.abf9bc9d.js"><link rel="prefetch" href="/GOFamily/assets/js/109.7ee4cfe4.js"><link rel="prefetch" href="/GOFamily/assets/js/11.0307bcae.js"><link rel="prefetch" href="/GOFamily/assets/js/110.25bb24d2.js"><link rel="prefetch" href="/GOFamily/assets/js/111.800f7506.js"><link rel="prefetch" href="/GOFamily/assets/js/112.b73333d2.js"><link rel="prefetch" href="/GOFamily/assets/js/113.3bed7499.js"><link rel="prefetch" href="/GOFamily/assets/js/114.c126b120.js"><link rel="prefetch" href="/GOFamily/assets/js/115.773ca7ce.js"><link rel="prefetch" href="/GOFamily/assets/js/12.521ef871.js"><link rel="prefetch" href="/GOFamily/assets/js/13.6a579e8b.js"><link rel="prefetch" href="/GOFamily/assets/js/14.fa863532.js"><link rel="prefetch" href="/GOFamily/assets/js/15.ccbbdb7a.js"><link rel="prefetch" href="/GOFamily/assets/js/16.2a7384f8.js"><link rel="prefetch" href="/GOFamily/assets/js/17.50442aef.js"><link rel="prefetch" href="/GOFamily/assets/js/18.4b8a1599.js"><link rel="prefetch" href="/GOFamily/assets/js/19.fce83f0a.js"><link rel="prefetch" href="/GOFamily/assets/js/20.c57281b8.js"><link rel="prefetch" href="/GOFamily/assets/js/21.19939807.js"><link rel="prefetch" href="/GOFamily/assets/js/22.a6f2abf2.js"><link rel="prefetch" href="/GOFamily/assets/js/23.a3a10d16.js"><link rel="prefetch" href="/GOFamily/assets/js/24.edf743ad.js"><link rel="prefetch" href="/GOFamily/assets/js/25.c1fe94a5.js"><link rel="prefetch" href="/GOFamily/assets/js/26.529d156a.js"><link rel="prefetch" href="/GOFamily/assets/js/27.baf2939d.js"><link rel="prefetch" href="/GOFamily/assets/js/28.69e5608b.js"><link rel="prefetch" href="/GOFamily/assets/js/29.742dd6e8.js"><link rel="prefetch" href="/GOFamily/assets/js/3.159fe1e3.js"><link rel="prefetch" href="/GOFamily/assets/js/30.4aafb94a.js"><link rel="prefetch" href="/GOFamily/assets/js/31.87baab0b.js"><link rel="prefetch" href="/GOFamily/assets/js/32.1ea926c5.js"><link rel="prefetch" href="/GOFamily/assets/js/33.4d31d0db.js"><link rel="prefetch" href="/GOFamily/assets/js/34.7610889f.js"><link rel="prefetch" href="/GOFamily/assets/js/35.07f8b036.js"><link rel="prefetch" href="/GOFamily/assets/js/36.d1acb39c.js"><link rel="prefetch" href="/GOFamily/assets/js/37.1fac0e0a.js"><link rel="prefetch" href="/GOFamily/assets/js/38.53670642.js"><link rel="prefetch" href="/GOFamily/assets/js/39.9c8315fb.js"><link rel="prefetch" href="/GOFamily/assets/js/4.a73c4d70.js"><link rel="prefetch" href="/GOFamily/assets/js/40.c47687be.js"><link rel="prefetch" href="/GOFamily/assets/js/41.73deb46e.js"><link rel="prefetch" href="/GOFamily/assets/js/42.85cfacd9.js"><link rel="prefetch" href="/GOFamily/assets/js/43.1b441a63.js"><link rel="prefetch" href="/GOFamily/assets/js/44.5dc33e34.js"><link rel="prefetch" href="/GOFamily/assets/js/45.e7e66273.js"><link rel="prefetch" href="/GOFamily/assets/js/46.146ccd16.js"><link rel="prefetch" href="/GOFamily/assets/js/47.aa0964bb.js"><link rel="prefetch" href="/GOFamily/assets/js/48.0f67a15e.js"><link rel="prefetch" href="/GOFamily/assets/js/49.565c30a8.js"><link rel="prefetch" href="/GOFamily/assets/js/5.864fc44c.js"><link rel="prefetch" href="/GOFamily/assets/js/50.0f964c86.js"><link rel="prefetch" href="/GOFamily/assets/js/51.9dd5ff4a.js"><link rel="prefetch" href="/GOFamily/assets/js/52.d3f06485.js"><link rel="prefetch" href="/GOFamily/assets/js/53.60bb95e9.js"><link rel="prefetch" href="/GOFamily/assets/js/54.ee26f0f5.js"><link rel="prefetch" href="/GOFamily/assets/js/55.7b5dc58d.js"><link rel="prefetch" href="/GOFamily/assets/js/56.e3024720.js"><link rel="prefetch" href="/GOFamily/assets/js/57.74cebe2c.js"><link rel="prefetch" href="/GOFamily/assets/js/58.2eea170e.js"><link rel="prefetch" href="/GOFamily/assets/js/59.a733d97b.js"><link rel="prefetch" href="/GOFamily/assets/js/6.f4af1c68.js"><link rel="prefetch" href="/GOFamily/assets/js/60.31fce32e.js"><link rel="prefetch" href="/GOFamily/assets/js/61.025df443.js"><link rel="prefetch" href="/GOFamily/assets/js/62.dfeb9d10.js"><link rel="prefetch" href="/GOFamily/assets/js/63.088bb315.js"><link rel="prefetch" href="/GOFamily/assets/js/64.7503aa28.js"><link rel="prefetch" href="/GOFamily/assets/js/65.9e82002d.js"><link rel="prefetch" href="/GOFamily/assets/js/66.fd22a77b.js"><link rel="prefetch" href="/GOFamily/assets/js/67.613f77e3.js"><link rel="prefetch" href="/GOFamily/assets/js/68.42cf41b2.js"><link rel="prefetch" href="/GOFamily/assets/js/69.a1051de8.js"><link rel="prefetch" href="/GOFamily/assets/js/7.5c52a687.js"><link rel="prefetch" href="/GOFamily/assets/js/70.8c3a3873.js"><link rel="prefetch" href="/GOFamily/assets/js/71.57746954.js"><link rel="prefetch" href="/GOFamily/assets/js/72.5afe8bc8.js"><link rel="prefetch" href="/GOFamily/assets/js/73.03d8974c.js"><link rel="prefetch" href="/GOFamily/assets/js/74.4f1eeb3c.js"><link rel="prefetch" href="/GOFamily/assets/js/75.d44fc2e7.js"><link rel="prefetch" href="/GOFamily/assets/js/76.f53bf284.js"><link rel="prefetch" href="/GOFamily/assets/js/77.bad2588a.js"><link rel="prefetch" href="/GOFamily/assets/js/78.2ee31447.js"><link rel="prefetch" href="/GOFamily/assets/js/79.f5c3f20d.js"><link rel="prefetch" href="/GOFamily/assets/js/8.419c1695.js"><link rel="prefetch" href="/GOFamily/assets/js/80.5aa44af4.js"><link rel="prefetch" href="/GOFamily/assets/js/81.33455a03.js"><link rel="prefetch" href="/GOFamily/assets/js/82.9f2284bd.js"><link rel="prefetch" href="/GOFamily/assets/js/83.5dc60988.js"><link rel="prefetch" href="/GOFamily/assets/js/84.b93653e7.js"><link rel="prefetch" href="/GOFamily/assets/js/85.17171820.js"><link rel="prefetch" href="/GOFamily/assets/js/86.411754fa.js"><link rel="prefetch" href="/GOFamily/assets/js/87.94cb9c84.js"><link rel="prefetch" href="/GOFamily/assets/js/88.bf9b9181.js"><link rel="prefetch" href="/GOFamily/assets/js/89.30daa2d3.js"><link rel="prefetch" href="/GOFamily/assets/js/9.0852bf61.js"><link rel="prefetch" href="/GOFamily/assets/js/90.86c77607.js"><link rel="prefetch" href="/GOFamily/assets/js/91.77196b7c.js"><link rel="prefetch" href="/GOFamily/assets/js/92.52bff9af.js"><link rel="prefetch" href="/GOFamily/assets/js/93.2ad1e17b.js"><link rel="prefetch" href="/GOFamily/assets/js/94.cb498e95.js"><link rel="prefetch" href="/GOFamily/assets/js/95.3eff79bb.js"><link rel="prefetch" href="/GOFamily/assets/js/96.01bee062.js"><link rel="prefetch" href="/GOFamily/assets/js/97.46e63812.js"><link rel="prefetch" href="/GOFamily/assets/js/98.843925cf.js"><link rel="prefetch" href="/GOFamily/assets/js/99.d9206bf1.js">
    <link rel="stylesheet" href="/GOFamily/assets/css/0.styles.93ee3edc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/GOFamily/" class="home-link router-link-active"><img src="https://avatars.githubusercontent.com/u/42873232" alt="GOFamily - go 程序员宝典" class="logo"> <span class="site-name can-hide">GOFamily - go 程序员宝典</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/GOFamily/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Menu" class="dropdown-title"><span class="title">系列教程</span> <span class="arrow down"></span></button> <button type="button" aria-label="Menu" class="mobile-dropdown-title"><span class="title">系列教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/GOFamily/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GOFamily 【go语言教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/408/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  408  【基础408知识教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/luban/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  luban  【系统设计教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/dingdang/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  dingdang  【工具教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/god/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  god  【给程序员写的书】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://shgopher.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/shgopher/GOFamily" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/GOFamily/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Menu" class="dropdown-title"><span class="title">系列教程</span> <span class="arrow down"></span></button> <button type="button" aria-label="Menu" class="mobile-dropdown-title"><span class="title">系列教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/GOFamily/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GOFamily 【go语言教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/408/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  408  【基础408知识教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/luban/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  luban  【系统设计教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/dingdang/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  dingdang  【工具教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/god/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  god  【给程序员写的书】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://shgopher.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/shgopher/GOFamily" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>内存模型</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#介绍一些-go-语言中的基本操作" class="sidebar-link">介绍一些 go 语言中的基本操作</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#内存模型存存在的意义" class="sidebar-link">内存模型存存在的意义</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#具体表现" class="sidebar-link">具体表现</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#三条定律" class="sidebar-link">三条定律</a></li></ul></li><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#重排和可见性" class="sidebar-link">重排和可见性</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#同步操作的-happens-before" class="sidebar-link">同步操作的 happens-before</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#单个-goroutine" class="sidebar-link">单个 goroutine</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#init-函数" class="sidebar-link">init 函数</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#goroutine" class="sidebar-link">goroutine</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#channel" class="sidebar-link">channel</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#mutex-rwmutex" class="sidebar-link">Mutex/RWMutex</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#waitgroup" class="sidebar-link">WaitGroup</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#once" class="sidebar-link">Once</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#atomic" class="sidebar-link">atomic</a></li></ul></li><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#issues" class="sidebar-link">issues</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="内存模型">内存模型</h1> <p>go 官方介绍 go 内存模型的时候说：探究在什么条件下，A goroutine 在读取一个变量的值的时，能够看到其它 goroutine 对这个变量进行的写的结果。</p> <p>我们为什么需要内存模型？</p> <p>CPU 指令可能会被重排序，并且存在多级缓存，例如 Go 语言中的多级内存模型。不同的 CPU 架构 (比如 x86 和 ARM) 也会对指令顺序产生影响，编译器优化也可能改变指令顺序。</p> <p>因此，编程语言需要一个内存规范，也就是内存模型，来规定程序中的内存访问和同步的语义，保证在不同的硬件和编译器下，程序的执行结果保持一致</p> <h2 id="介绍一些-go-语言中的基本操作">介绍一些 go 语言中的基本操作</h2> <blockquote><p>除了基本的读和写之外都是同步操作，包括以下列举的，并且更多以这些基础操作衍生出的操作。</p></blockquote> <ul><li>读
<ul><li>基础的读
<ul><li>对超过机器 word 大小的值读，可以看作是拆成 word 大小的几个读的无序进行</li></ul></li> <li>原子包的读</li> <li>使用 sync.Mux 的读</li> <li>使用 channel 形式的读</li></ul></li> <li>写
<ul><li>基础的写
<ul><li>变量的初始化就是一个写操作</li> <li>对超过机器 word 大小的值写，可以看作是拆成 word 大小的几个写的无序进行</li></ul></li> <li>原子包的写</li> <li>sync.mux 的写</li> <li>向 channel 发送数据</li></ul></li> <li>atomic 的 compare and swap 操作，兼顾了写和读</li></ul> <p>我们讨论 go 内存模型的时候，主要聚焦下面四种细节的<strong>差异性</strong>：</p> <ul><li>操作的种类：
<ul><li>普通的读或者写</li> <li><strong>同步操作</strong>，比如利用 sync 包进行同步，利用 channel 在不同的 goroutine 中间进行同步，利用 atomic 包进行同步等。</li></ul></li> <li>这个操作者在程序中的位置</li> <li>被操作者在内存位置，或者是被访问的变量的位置</li> <li>被操作者值的类型</li></ul> <h2 id="内存模型存存在的意义">内存模型存存在的意义</h2> <ul><li><p>给程序员一个最根本的法则 --- 你只要遵循这个法则，那么在进行多 goroutine 数据访问的时候，做串行控制 (使用同步操作) 一定会成功。</p></li> <li><p>给编译器优化开发者一个法则，只要遵循这个法则，就能不出错的做出编译器级别的优化。</p></li></ul> <h3 id="具体表现">具体表现</h3> <ul><li><strong>探究可见性</strong></li> <li><strong>happens- before</strong>：x 操作一定在 y 操作之前执行完毕，这里说的并不是时间，而是 “执行完毕” 这个结论，我们可以放心的在 y 中使用 x 的执行结果。主要突出的是这个完成性。</li></ul> <h3 id="三条定律">三条定律</h3> <ul><li><p>在一个 goroutine 中，程序执行的顺序一定是符合代码写的顺序的。但是不同的 goroutine 中这个定理失效。</p></li> <li><p>在<strong>同步操作</strong>的时候，从 a goroutine 看到 b goroutine 的执行顺序，必须符合同步操作的顺序，这里举个例子，举例：b 的同步操作是什么顺序，那么 a 读取的就是什么顺序。比如 b 中有三个 Channel，他们执行的顺序是先 a 发 b 收，b 发，c 收，那么在 a 中读取的顺序跟这个同步的操作顺序是一致的，<strong>如果不是同步操作就可能不一致。</strong></p></li> <li><p>对于非同步操作的普通读和写，如果 b 操作了 a，那么必须成立</p> <ul><li>b 发生在 a 之前</li></ul></li></ul> <p>我们可以使用 <code>go build -race</code> 来发现数据竞争。</p> <p>接下来我们对于内存模型的具体表现进行更具体的介绍。</p> <h2 id="重排和可见性">重排和可见性</h2> <p>由于指令的重排，代码<strong>不一定</strong>会按照你写的顺序执行。</p> <p>这里给出一个案例：有两个 goroutine 分别是 g1，和 g2，g1 读某个变量的数据，g2 写这个变量的数据，当 g1 读取到 g2 写的新数据之后，你也不一定能读取到在 goroutine g2 中排列在这个写数据操作之前的操作：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	a    <span class="token operator">=</span> <span class="token number">1</span>
	b    <span class="token operator">=</span> <span class="token number">2</span>
	done <span class="token builtin">bool</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		a <span class="token operator">=</span> <span class="token number">3</span>
		b <span class="token operator">=</span> <span class="token number">4</span>
		done <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>done <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 可能观察到的就是输出的 4 3，但是无法保证必须是4 3 ，能观察到 != 保证</span>
<span class="token punctuation">}</span>

</code></pre></div><p>下面这种情况，a goroutine 无法观察到 b goroutine 是否完成了写操作，有可能造成 a goroutine 一直被卡的现象：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Result <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	data <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	r <span class="token operator">*</span>Result
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	d <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Result<span class="token punctuation">)</span>
	d<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">&quot;hi there&quot;</span> <span class="token comment">// 这里无法确认一定会运行</span>
	r <span class="token operator">=</span> d <span class="token comment">// 这里无法确认观察到</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">go</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> r <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>there is no guarantee that the write to done will ever be observed by main，<strong>since there are no synchronization events between the two threads</strong>。The loop in main is not guaranteed to finish。“</p></blockquote> <p>这一句是 go blog 中对于这代代码的描述，重点是说，这俩线程中，没有存在同步原语，所以无法做到从 main goroutine 去观测到 r 的状态，也就是说，在 goroutine 中只要存在了同步原语，那么就可以把两个 goroutine 当作正常的语句来看。</p> <p>这里有两点无法确认，第一：主 goroutine 无法<strong>确认</strong> r 的状态，这里指的就是<strong>可观测性</strong>，因为这里是非同步操作，所以主 goroutine 的读无法观测到 <code>go set（）</code> 这里 <code>r = d</code> 这里的写，注意是无法完全确认，通常来说这段代码是可以运行的，我说的是通常，第二无法保证 <code>d.data</code> 一定会运行，所以有可能输出的是空字符串，这里说的就是因为编译优化导致的指令重排。</p> <h2 id="同步操作的-happens-before">同步操作的 happens-before</h2> <p>go 不直接提供 cpu 屏障，来保证编译器或者 cpu 保证顺序性，而是使用不同架构的内存屏障指令来实现统一的并发原语。</p> <h3 id="单个-goroutine">单个 goroutine</h3> <p>上文说到，<strong>在一个 goroutine 中，happens- before 其实就等于代码书写的顺序，这一点是严格成立的</strong>。</p> <h3 id="init-函数">init 函数</h3> <p>go 语言的初始化是在单一的 goroutine 中执行的，也就是 main goroutine。</p> <p><strong>p 包导入了 q 包，那么 q 的 init 函数一定 happens before p 的任何初始化代码</strong>。</p> <p>这里有点像树，导入的过程，以及初始化的过程，会形成一个多叉树，从最底层的树开始进行初始化，逐步的忘上层走，先进后出，栈一样的感觉，并且相同的包只会导入一次，进而也只会初始化一次，比如 q 包被第三层导入了，在第五层也导入了，那么这个包在从底层往上走的过程中，只会在第五层先全局变量后 init 函数的初始化一次。这导入的包全部初始化一遍之后，才开始进行 main 包的 mian 函数，然后进而去运行接下来的逻辑。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span><span class="token punctuation">(</span>
  a <span class="token operator">=</span> c <span class="token operator">+</span> b

  b <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  c <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  d <span class="token operator">=</span> <span class="token number">3</span> 
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span><span class="token punctuation">{</span>
  d <span class="token operator">++</span> 
  <span class="token keyword">return</span> d 
<span class="token punctuation">}</span>
</code></pre></div><p>初始化的顺序是这样的，首先初始化 a，因为 a = c + b，那么系统开始初始化 c 和 b，c 和 b 等于一个函数 f，那么就开始初始化这个函数，函数里面是 d 那么开始初始化 d，所以 b = 3+1 c = 3+1+1 a = 9，这个时候 d 已经++ 两次了，所以最终的初始化以后 a = 9 b = 4 c = 5 d = 5</p> <p>包级别的变量按照代码顺序初始化，同一个包的众多文件会按照文件名的排列顺序进行初始化。</p> <h3 id="goroutine">goroutine</h3> <p>启动 goroutine 的 go 语言执行，一定 happens - before 此 goroutine 内的代码执行。退出可就没有任何 happens- before 的理论了，所以退出我们通常要部署同步语句。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token builtin">string</span>
<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  a <span class="token operator">=</span> <span class="token string">&quot;hi&quot;</span>
  <span class="token keyword">go</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从单个 goroutine 的 happens- before 的关系来看，a = “hi” 一定 happens- before go f ()，从新 goroutine 的开辟来说，go f () 一定 happens- before fmt.Println 所以这个代码中，hi 一定能被输出。</p> <h3 id="channel">channel</h3> <p>go 语言有一句经典名言，不要使用共享内存来通信 (sync.Mutex) 而应该采用通信的方式来共享内存，这个后者说的就是 channel，channel 是同步操作的首选。</p> <ul><li>往 channel 中发数据，happens - before 从这个 channel 接收数据<strong>完成</strong>。注意这里说的是接收完成，<strong>没说</strong>发数据 happens- before 这个 channel 接受数据开始的时候。</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> a <span class="token builtin">string</span> 

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//这里之所以a = hi 发生在 c &lt;-0 之前，就是因为这个goroutine和main goroutine 存在同步原语，</span>
  <span class="token comment">//只要存在，那么代码就会按照程序员写的顺序执行，并不会进行重排。</span>
  a <span class="token operator">=</span> <span class="token string">&quot;hi&quot;</span> 
  c <span class="token operator">&lt;-</span><span class="token number">0</span>  <span class="token comment">// 这里因为有了同步操作，所以 a = “hi” 在main goroutine看 也是 a= “hi” happens- before c &lt;- 0</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">go</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">&lt;-</span>c <span class="token comment">// 这里只要收到数据了，那么 c &lt;- 0 肯定已经运行了，并且发送完毕了。</span>
  <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>close 一个 channel 一定 happens- before 从关闭的 channel 中读取一个零值。我们都知道可以从一个 closed 的一个 channel 中读取零值是可以的，这里说明的是读零值这个过程一定在关闭这个操作之后。</p></li> <li><p>一个 unbuffered 的 channle，读的准备好一定 happens-before 发准备好，意思是说，只有收数据准备好了，才能发，否则就会一直卡在发那个地方。</p></li> <li><p>一个容量大于 0 为 m 的 channel，第 n 个接收，一定 happens- before 第 n+m 的发送，意思是说，如果容量满了，必须先拿出来一个才能往里面再塞进去一个。比如：n=1 m=2，第一个接收一定 happens- before 第三个发送，因为容量一共是 2，要想往里面塞进去第三个，<strong>必须拿出来一个并且拿出来这个操作完毕了</strong>，才能发送第三个。</p></li></ul> <h3 id="mutex-rwmutex">Mutex/RWMutex</h3> <ul><li>第 n 次的 unlock 一定 happends- before 第 n+1 次 lock 方法的返回
意思是说，只有先解锁才能再次加锁。</li> <li>读写锁虽然有两把锁，但是不能同时使用，必须等待一个锁解锁后，另一个锁才能上锁，比如读锁解锁后才能再次上读锁，或者才能上写锁。</li></ul> <p>互斥锁可以由 a goroutine 上锁，b goroutine 解锁</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>Mutex
<span class="token keyword">var</span> s <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  s <span class="token operator">=</span> <span class="token string">&quot;hi&quot;</span>
  mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 这里拥有了一个同步原语，所以 s = hi 一定发生在 mu.unlock() 之前。（相当于在一段锁的内部）</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">go</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 这里的lock 一定发生在  另一个goroutine 中f 的 mu.Unlock() 之后。</span>
  <span class="token function">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="waitgroup">WaitGroup</h3> <ul><li>wait 方法等到计数值归零才能返回 (运行完毕)</li></ul> <h3 id="once">Once</h3> <ul><li>对于 once.Do(f) f 一定会在 do 方法返回之前执行。</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> s <span class="token builtin">string</span>
<span class="token keyword">var</span> once sync<span class="token punctuation">.</span>Once

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
  s <span class="token operator">=</span> <span class="token string">&quot;hi&quot;</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
  <span class="token function">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// 这里 f 的执行完毕 一定在 Do()返回之前,所以一定能输出 s = hi</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="atomic">atomic</h3> <p>按照 atomic load / store 顺序来保证 happens - before 不过 go 官方并没有严格定义，直到目前为止并没有严格定义。</p> <div class="language-go extra-class"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> a<span class="token punctuation">,</span> b <span class="token builtin">int32</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">for</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">{</span>
    runtime<span class="token punctuation">.</span><span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="issues">issues</h2> <p><code>使用channel实现一个互斥锁</code></p> <p>我们利用 channel 发送数据 happens- before 收到数据完毕这个特性来实现互斥锁。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Locker <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ch  <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 初始状态是已经有一个</span>
<span class="token keyword">func</span> <span class="token function">NewLocker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>Locker<span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Locker<span class="token punctuation">{</span>
		ch<span class="token punctuation">:</span> ch<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// lock 从缓存是1编程0，从chan中取出来数据</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Locker<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token operator">&lt;-</span> l<span class="token punctuation">.</span>ch
<span class="token punctuation">}</span>
<span class="token comment">// unlock 将缓存从0变成1，向ch中放入数据。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Locker<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	l<span class="token punctuation">.</span>ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一个小小的经验：channel 拥有 buffer 比没有 buffer 常用很多。</p> <p>完结。</p> <h2 id="参考资料">参考资料</h2> <ul><li>https://go.dev/ref/mem</li> <li>https://time.geekbang.org/column/article/307469</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/shgopher/GOFamily/edit/release/并发/内存模型/README.md" target="_blank" rel="noopener noreferrer">在GitHub中编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">1/23/2024, 7:58:45 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/GOFamily/assets/js/app.6dac5fbf.js" defer></script><script src="/GOFamily/assets/js/2.5c331e53.js" defer></script><script src="/GOFamily/assets/js/108.339b1d12.js" defer></script>
  </body>
</html>
