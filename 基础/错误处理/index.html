<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>GOFamily - go 程序员宝典</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" type="image/x-icon" href="/GOFamily/favicon.ico">
    <meta name="description" content="🔥 go 程序员宝典，包含了：算法，数据库，网络操作系统，分布式，系统设计等一揽子知识体系">
    
    <link rel="preload" href="/GOFamily/assets/css/0.styles.93ee3edc.css" as="style"><link rel="preload" href="/GOFamily/assets/js/app.6dac5fbf.js" as="script"><link rel="preload" href="/GOFamily/assets/js/2.5c331e53.js" as="script"><link rel="preload" href="/GOFamily/assets/js/44.5dc33e34.js" as="script"><link rel="prefetch" href="/GOFamily/assets/js/10.993cf521.js"><link rel="prefetch" href="/GOFamily/assets/js/100.8a13422e.js"><link rel="prefetch" href="/GOFamily/assets/js/101.56e8a149.js"><link rel="prefetch" href="/GOFamily/assets/js/102.0befb22b.js"><link rel="prefetch" href="/GOFamily/assets/js/103.318b2dd9.js"><link rel="prefetch" href="/GOFamily/assets/js/104.5190ec56.js"><link rel="prefetch" href="/GOFamily/assets/js/105.27135b71.js"><link rel="prefetch" href="/GOFamily/assets/js/106.ee0a923b.js"><link rel="prefetch" href="/GOFamily/assets/js/107.abf9bc9d.js"><link rel="prefetch" href="/GOFamily/assets/js/108.339b1d12.js"><link rel="prefetch" href="/GOFamily/assets/js/109.7ee4cfe4.js"><link rel="prefetch" href="/GOFamily/assets/js/11.0307bcae.js"><link rel="prefetch" href="/GOFamily/assets/js/110.25bb24d2.js"><link rel="prefetch" href="/GOFamily/assets/js/111.800f7506.js"><link rel="prefetch" href="/GOFamily/assets/js/112.b73333d2.js"><link rel="prefetch" href="/GOFamily/assets/js/113.3bed7499.js"><link rel="prefetch" href="/GOFamily/assets/js/114.c126b120.js"><link rel="prefetch" href="/GOFamily/assets/js/115.773ca7ce.js"><link rel="prefetch" href="/GOFamily/assets/js/12.521ef871.js"><link rel="prefetch" href="/GOFamily/assets/js/13.6a579e8b.js"><link rel="prefetch" href="/GOFamily/assets/js/14.fa863532.js"><link rel="prefetch" href="/GOFamily/assets/js/15.ccbbdb7a.js"><link rel="prefetch" href="/GOFamily/assets/js/16.2a7384f8.js"><link rel="prefetch" href="/GOFamily/assets/js/17.50442aef.js"><link rel="prefetch" href="/GOFamily/assets/js/18.4b8a1599.js"><link rel="prefetch" href="/GOFamily/assets/js/19.fce83f0a.js"><link rel="prefetch" href="/GOFamily/assets/js/20.c57281b8.js"><link rel="prefetch" href="/GOFamily/assets/js/21.19939807.js"><link rel="prefetch" href="/GOFamily/assets/js/22.a6f2abf2.js"><link rel="prefetch" href="/GOFamily/assets/js/23.a3a10d16.js"><link rel="prefetch" href="/GOFamily/assets/js/24.edf743ad.js"><link rel="prefetch" href="/GOFamily/assets/js/25.c1fe94a5.js"><link rel="prefetch" href="/GOFamily/assets/js/26.529d156a.js"><link rel="prefetch" href="/GOFamily/assets/js/27.baf2939d.js"><link rel="prefetch" href="/GOFamily/assets/js/28.69e5608b.js"><link rel="prefetch" href="/GOFamily/assets/js/29.742dd6e8.js"><link rel="prefetch" href="/GOFamily/assets/js/3.159fe1e3.js"><link rel="prefetch" href="/GOFamily/assets/js/30.4aafb94a.js"><link rel="prefetch" href="/GOFamily/assets/js/31.87baab0b.js"><link rel="prefetch" href="/GOFamily/assets/js/32.1ea926c5.js"><link rel="prefetch" href="/GOFamily/assets/js/33.4d31d0db.js"><link rel="prefetch" href="/GOFamily/assets/js/34.7610889f.js"><link rel="prefetch" href="/GOFamily/assets/js/35.07f8b036.js"><link rel="prefetch" href="/GOFamily/assets/js/36.d1acb39c.js"><link rel="prefetch" href="/GOFamily/assets/js/37.1fac0e0a.js"><link rel="prefetch" href="/GOFamily/assets/js/38.53670642.js"><link rel="prefetch" href="/GOFamily/assets/js/39.9c8315fb.js"><link rel="prefetch" href="/GOFamily/assets/js/4.a73c4d70.js"><link rel="prefetch" href="/GOFamily/assets/js/40.c47687be.js"><link rel="prefetch" href="/GOFamily/assets/js/41.73deb46e.js"><link rel="prefetch" href="/GOFamily/assets/js/42.85cfacd9.js"><link rel="prefetch" href="/GOFamily/assets/js/43.1b441a63.js"><link rel="prefetch" href="/GOFamily/assets/js/45.e7e66273.js"><link rel="prefetch" href="/GOFamily/assets/js/46.146ccd16.js"><link rel="prefetch" href="/GOFamily/assets/js/47.aa0964bb.js"><link rel="prefetch" href="/GOFamily/assets/js/48.0f67a15e.js"><link rel="prefetch" href="/GOFamily/assets/js/49.565c30a8.js"><link rel="prefetch" href="/GOFamily/assets/js/5.864fc44c.js"><link rel="prefetch" href="/GOFamily/assets/js/50.0f964c86.js"><link rel="prefetch" href="/GOFamily/assets/js/51.9dd5ff4a.js"><link rel="prefetch" href="/GOFamily/assets/js/52.d3f06485.js"><link rel="prefetch" href="/GOFamily/assets/js/53.60bb95e9.js"><link rel="prefetch" href="/GOFamily/assets/js/54.ee26f0f5.js"><link rel="prefetch" href="/GOFamily/assets/js/55.7b5dc58d.js"><link rel="prefetch" href="/GOFamily/assets/js/56.e3024720.js"><link rel="prefetch" href="/GOFamily/assets/js/57.74cebe2c.js"><link rel="prefetch" href="/GOFamily/assets/js/58.2eea170e.js"><link rel="prefetch" href="/GOFamily/assets/js/59.a733d97b.js"><link rel="prefetch" href="/GOFamily/assets/js/6.f4af1c68.js"><link rel="prefetch" href="/GOFamily/assets/js/60.31fce32e.js"><link rel="prefetch" href="/GOFamily/assets/js/61.025df443.js"><link rel="prefetch" href="/GOFamily/assets/js/62.dfeb9d10.js"><link rel="prefetch" href="/GOFamily/assets/js/63.088bb315.js"><link rel="prefetch" href="/GOFamily/assets/js/64.7503aa28.js"><link rel="prefetch" href="/GOFamily/assets/js/65.9e82002d.js"><link rel="prefetch" href="/GOFamily/assets/js/66.fd22a77b.js"><link rel="prefetch" href="/GOFamily/assets/js/67.613f77e3.js"><link rel="prefetch" href="/GOFamily/assets/js/68.42cf41b2.js"><link rel="prefetch" href="/GOFamily/assets/js/69.a1051de8.js"><link rel="prefetch" href="/GOFamily/assets/js/7.5c52a687.js"><link rel="prefetch" href="/GOFamily/assets/js/70.8c3a3873.js"><link rel="prefetch" href="/GOFamily/assets/js/71.57746954.js"><link rel="prefetch" href="/GOFamily/assets/js/72.5afe8bc8.js"><link rel="prefetch" href="/GOFamily/assets/js/73.03d8974c.js"><link rel="prefetch" href="/GOFamily/assets/js/74.4f1eeb3c.js"><link rel="prefetch" href="/GOFamily/assets/js/75.d44fc2e7.js"><link rel="prefetch" href="/GOFamily/assets/js/76.f53bf284.js"><link rel="prefetch" href="/GOFamily/assets/js/77.bad2588a.js"><link rel="prefetch" href="/GOFamily/assets/js/78.2ee31447.js"><link rel="prefetch" href="/GOFamily/assets/js/79.f5c3f20d.js"><link rel="prefetch" href="/GOFamily/assets/js/8.419c1695.js"><link rel="prefetch" href="/GOFamily/assets/js/80.5aa44af4.js"><link rel="prefetch" href="/GOFamily/assets/js/81.33455a03.js"><link rel="prefetch" href="/GOFamily/assets/js/82.9f2284bd.js"><link rel="prefetch" href="/GOFamily/assets/js/83.5dc60988.js"><link rel="prefetch" href="/GOFamily/assets/js/84.b93653e7.js"><link rel="prefetch" href="/GOFamily/assets/js/85.17171820.js"><link rel="prefetch" href="/GOFamily/assets/js/86.411754fa.js"><link rel="prefetch" href="/GOFamily/assets/js/87.94cb9c84.js"><link rel="prefetch" href="/GOFamily/assets/js/88.bf9b9181.js"><link rel="prefetch" href="/GOFamily/assets/js/89.30daa2d3.js"><link rel="prefetch" href="/GOFamily/assets/js/9.0852bf61.js"><link rel="prefetch" href="/GOFamily/assets/js/90.86c77607.js"><link rel="prefetch" href="/GOFamily/assets/js/91.77196b7c.js"><link rel="prefetch" href="/GOFamily/assets/js/92.52bff9af.js"><link rel="prefetch" href="/GOFamily/assets/js/93.2ad1e17b.js"><link rel="prefetch" href="/GOFamily/assets/js/94.cb498e95.js"><link rel="prefetch" href="/GOFamily/assets/js/95.3eff79bb.js"><link rel="prefetch" href="/GOFamily/assets/js/96.01bee062.js"><link rel="prefetch" href="/GOFamily/assets/js/97.46e63812.js"><link rel="prefetch" href="/GOFamily/assets/js/98.843925cf.js"><link rel="prefetch" href="/GOFamily/assets/js/99.d9206bf1.js">
    <link rel="stylesheet" href="/GOFamily/assets/css/0.styles.93ee3edc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/GOFamily/" class="home-link router-link-active"><img src="https://avatars.githubusercontent.com/u/42873232" alt="GOFamily - go 程序员宝典" class="logo"> <span class="site-name can-hide">GOFamily - go 程序员宝典</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/GOFamily/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Menu" class="dropdown-title"><span class="title">系列教程</span> <span class="arrow down"></span></button> <button type="button" aria-label="Menu" class="mobile-dropdown-title"><span class="title">系列教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/GOFamily/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GOFamily 【go语言教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/408/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  408  【基础408知识教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/luban/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  luban  【系统设计教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/dingdang/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  dingdang  【工具教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/god/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  god  【给程序员写的书】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://shgopher.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/shgopher/GOFamily" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/GOFamily/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Menu" class="dropdown-title"><span class="title">系列教程</span> <span class="arrow down"></span></button> <button type="button" aria-label="Menu" class="mobile-dropdown-title"><span class="title">系列教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/GOFamily/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GOFamily 【go语言教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/408/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  408  【基础408知识教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/luban/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  luban  【系统设计教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/dingdang/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  dingdang  【工具教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/god/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  god  【给程序员写的书】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://shgopher.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/shgopher/GOFamily" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#错误处理的基本认识" class="sidebar-link">错误处理的基本认识</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#error-的本质是什么" class="sidebar-link">Error 的本质是什么？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#自定义-error" class="sidebar-link">自定义 error</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#errors-is" class="sidebar-link">errors.Is()</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#errors-as" class="sidebar-link">errors.As()</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#errors-join" class="sidebar-link">errors.Join()</a></li></ul></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#当错误处理遇到了-defer" class="sidebar-link">当错误处理遇到了 defer</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#错误处理实战的五种方式" class="sidebar-link">错误处理实战的五种方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#经典的错误处理方式" class="sidebar-link">经典的错误处理方式</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#屏蔽过程中的错误处理" class="sidebar-link">屏蔽过程中的错误处理</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#分层架构中的错误处理方法" class="sidebar-link">分层架构中的错误处理方法</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#pkg-errors" class="sidebar-link">pkg/errors</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#errgroup-的使用技巧" class="sidebar-link">errgroup 的使用技巧</a></li></ul></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#错误处理相关技巧" class="sidebar-link">错误处理相关技巧</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#使用-errors-new-时要写清楚包名" class="sidebar-link">使用 errors.New() 时要写清楚包名</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#使用-error-处理一般错误-使用-panic-处理严重错误-异常" class="sidebar-link">使用 error 处理一般错误，使用 panic 处理严重错误 (异常)</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#基础库-应该避免使用-error-types" class="sidebar-link">基础库，应该避免使用 error types</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#优化不必要的代码让程序变得更简洁" class="sidebar-link">优化不必要的代码让程序变得更简洁</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#错误应该只处理一次" class="sidebar-link">错误应该只处理一次</a></li></ul></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#业务-code-码的设置" class="sidebar-link">业务 code 码的设置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#一律返回-http-status-200-具体-code-码单独设置" class="sidebar-link">一律返回 http status 200，具体 code 码单独设置</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#使用合适的-http-status-code-简单的信息以及业务错误代码" class="sidebar-link">使用合适的 http status code + 简单的信息以及业务错误代码</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#使用合适的-http-status-code-非常详细的业务错误代码以及信息" class="sidebar-link">使用合适的 http status code + 非常详细的业务错误代码以及信息</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#业务-code-码的具体设计" class="sidebar-link">业务 code 码的具体设计</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#如何设置-http-status-code" class="sidebar-link">如何设置 http status code</a></li></ul></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#设计一个生产级的错误包" class="sidebar-link">设计一个生产级的错误包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#生产级的错误包需要的功能" class="sidebar-link">生产级的错误包需要的功能</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#具体实现" class="sidebar-link">具体实现</a></li></ul></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#issues" class="sidebar-link">issues</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="错误处理">错误处理</h1> <h2 id="错误处理的基本认识">错误处理的基本认识</h2> <p>在 go 语言中，没有传统编程语言的 <code>try - catch</code> 操作，go 语言中一切错误都需要显式处理：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;./x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre></div><p>通常，我们规定函数返回的最后一个数据是错误接口：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">age</span><span class="token punctuation">(</span>v <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> v <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;错误x&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们直接返回一个 err 是一种简单的做法，如果错误比较初级也可以这么做，但是如果想要带有更精确的提示信息，可以在返回的时候 wrap 一层信息：</p> <p>就以上文的读取数据为例</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;./&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;在读取数据的时候发生了错误，错误信息是：%w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>wrap 一层信息，对于错误的定位更加高效</p> <h2 id="error-的本质是什么">Error 的本质是什么？</h2> <p>错误处理的核心就是下面这一个 error 的接口</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> <span class="token builtin">error</span> <span class="token keyword">interface</span><span class="token punctuation">{</span>
	<span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以只要我们的自建类型实现了这个接口，就可以使用很多的错误处理的方法。</p> <h3 id="自定义-error">自定义 error</h3> <p>我们使用 errors.New() 的时候其实就是返回了一个 go 自建的，叫做 errorString 的实现了 error 接口的结构体。
这就是自建 error 的方法</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	e <span class="token operator">:=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// (0x47fd48,0xc00003e730)</span>
</code></pre></div><p>为了防止在比较错误的时候发生错误一致的情况，所以自建 error，返回的实际上是一个指针。</p> <blockquote><p>下文会提用什么方法进行比较 err，实际上就是 “两个接口类型是否相等 --- 类型一致，值一致”，如果返回的值是指针，那么值肯定就不可能一样了。</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// go 源代码</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>errorString<span class="token punctuation">{</span>s<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当我们使用 fmt.Errorf() 的时候，其实也是使用的上述方法。</p> <p>不过，如果我们使用了占位符 <code>%w</code> 时，将不会使用上述方法，而是使用了 wrapError：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> wrapError <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	msg <span class="token builtin">string</span>
	err <span class="token builtin">error</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>wrapError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">string</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> e<span class="token punctuation">.</span>msg
<span class="token punctuation">}</span>
<span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>wrapError<span class="token punctuation">)</span> <span class="token function">Unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> e<span class="token punctuation">.</span>err
<span class="token punctuation">}</span>
</code></pre></div><p>使用这种方式主要是为了错误链，那就让我们看一下如何使用错误链的相关操作。</p> <h3 id="errors-is">errors.Is()</h3> <p>上文我们说到，错误可以使用 wrap 的方式进行封装，那么如果我们想判断封装的这么多层的错误中，有没有哪一层错误等于我们要的值，可以使用这个函数进行判断：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	err <span class="token operator">:=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;err is now&quot;</span><span class="token punctuation">)</span>
	err1 <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;err1:%w&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	err2 <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;err1:%w&quot;</span><span class="token punctuation">,</span>err1<span class="token punctuation">)</span>
	<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err2<span class="token punctuation">,</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;是一个错误&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="errors-as">errors.As()</h3> <p>这个方法跟上文的 Is() 类似，只不过它判断的是类型是否一致。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> errS <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	a <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>errS<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> t<span class="token punctuation">.</span>a
<span class="token punctuation">}</span>

err <span class="token operator">:=</span> <span class="token operator">&amp;</span>errS<span class="token punctuation">{</span><span class="token string">&quot;typical error&quot;</span><span class="token punctuation">}</span>
err1 <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;wrap err: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
err2 <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;wrap err1: %w&quot;</span><span class="token punctuation">,</span> err1<span class="token punctuation">)</span>

<span class="token keyword">var</span> e <span class="token operator">*</span>errS
<span class="token comment">// 这里的 target 必须使用指针</span>
<span class="token keyword">if</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span>err2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;TypicalErr is not on the chain of err2&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;TypicalErr is on the chain of err2&quot;</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span>err <span class="token operator">==</span> e<span class="token punctuation">)</span>
</code></pre></div><h3 id="errors-join">errors.Join()</h3> <p>这个方法是将几个错误结合在一起的方法：</p> <div class="language-go extra-class"><pre class="language-go"><code>	err1 <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;err1:%w&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	err2 <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;err1:%w&quot;</span><span class="token punctuation">,</span>err1<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> errors<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>err1<span class="token punctuation">,</span>err2<span class="token punctuation">)</span>
</code></pre></div><h2 id="当错误处理遇到了-defer">当错误处理遇到了 defer</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> xx <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span> <span class="token punctuation">,</span>err
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token builtin">close</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段伪代码的意思是说，当有条件之后，返回一个错误，但是 defer 的内容发生在这个 err 被固定之后，所以 defer 中如果再有错误将不会被处理。</p> <p>那么我们该怎么更改呢？</p> <p>我想你一定想到了前文我们说过，使用带有变量的返回值是可以将 defer 的值进行返回的：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span> i <span class="token builtin">int</span><span class="token punctuation">,</span> e <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> xx <span class="token punctuation">{</span>
			e <span class="token operator">=</span> xx
			i <span class="token operator">=</span> xx
		<span class="token keyword">return</span> 
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token builtin">close</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么这种写法，defer 中如果发生了错误就会覆盖掉了程序执行中的 err，所以这种方法也是不行的，即使它能照顾到了 defer 中的错误处理。</p> <p>我们可以将错误处理都放在 defer 中处理就可以了</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span> i <span class="token builtin">int</span><span class="token punctuation">,</span> e <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> xx <span class="token punctuation">{</span>
		i <span class="token operator">=</span> xx
		e <span class="token operator">=</span> xx
		<span class="token keyword">return</span> 
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		e1 <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span>  e1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token function">log</span><span class="token punctuation">(</span>e1<span class="token punctuation">)</span> 
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> 
		<span class="token punctuation">}</span>
		err <span class="token operator">=</span> e1
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样，两种错误都能处理到了</p> <h2 id="错误处理实战的五种方式">错误处理实战的五种方式</h2> <h3 id="经典的错误处理方式">经典的错误处理方式</h3> <p>每一个步骤分别直接处理错误</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> age <span class="token keyword">interface</span><span class="token punctuation">{</span>
	<span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span>
	<span class="token function">putAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span>
	<span class="token function">allAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">D</span><span class="token punctuation">(</span>ag age<span class="token punctuation">)</span><span class="token builtin">error</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> ag<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%w&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> ag<span class="token punctuation">.</span><span class="token function">putAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%w&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> ag<span class="token punctuation">.</span><span class="token function">allAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	  <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%w&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="屏蔽过程中的错误处理">屏蔽过程中的错误处理</h3> <p>将错误放置在对象的内部进行处理：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> FileCopier <span class="token keyword">struct</span><span class="token punctuation">{</span>
	w <span class="token operator">*</span>os<span class="token punctuation">.</span>File
	r <span class="token operator">*</span>os<span class="token punctuation">.</span>File
	err <span class="token builtin">error</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FileCopier<span class="token punctuation">)</span><span class="token function">open</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span> <span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>err
	<span class="token punctuation">}</span>

	h<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err<span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span>err <span class="token operator">=</span> err
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> h<span class="token punctuation">,</span><span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span><span class="token punctuation">(</span>f <span class="token operator">*</span>FileCopier<span class="token punctuation">)</span><span class="token function">OpenSrc</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	f<span class="token punctuation">.</span>r<span class="token punctuation">,</span>f<span class="token punctuation">.</span>err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
	<span class="token keyword">return</span> 
<span class="token punctuation">}</span>
<span class="token keyword">func</span><span class="token punctuation">(</span>f <span class="token operator">*</span>FileCopier<span class="token punctuation">)</span> <span class="token function">CopyFile</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> f<span class="token punctuation">.</span>err
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span> f<span class="token punctuation">.</span>r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			f<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> f<span class="token punctuation">.</span>w<span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			f<span class="token punctuation">.</span>w<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> f<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> f<span class="token punctuation">.</span>w <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				os<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	
	f<span class="token punctuation">.</span><span class="token function">opensrc</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>
	f<span class="token punctuation">.</span><span class="token function">createDst</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span>err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码并不是特别完整，但是从中我们还是可以理解这种将错误放在对象中的写法的技巧。</p> <p>首先，错误直接放置在对象自身，在方法中首先去调用这个字段来看是否拥有错误，如果有，直接退出即可</p> <p>如果没有错误继续往下走，如果本次方法发生错误就继续将这个错误赋值给这个字段，</p> <p>当最后处理的方法时，这里也就是 copyfile 方法，我们在 defer 中要对于各个子方法进行判断，到底是哪个方法有错误，然后逐一进行判定。相当于处理错误的逻辑集中放置到了最后一个函数进行执行了。</p> <p>也就是说，将错误放置在对象本身的时候，通常应该为顺序调用的方法，一旦前者出现错误，后者即可退出</p> <p>如果不是顺序的执行过程，那么有些的错误就可能被湮没，导致错误无法被感知。</p> <h3 id="分层架构中的错误处理方法">分层架构中的错误处理方法</h3> <p>常见的分层架构</p> <ul><li>controller 控制层</li> <li>service 服务层</li> <li>dao 数据访问层</li></ul> <p>dao 层生产错误</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%w&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>service 追加错误</p> <div class="language-go extra-class"><pre class="language-go"><code>err <span class="token operator">:=</span> a<span class="token punctuation">.</span>Dao<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;getname err: %w&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>controller 打印错误</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span> err<span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="pkg-errors">pkg/errors</h3> <p>如果感觉标准库提供的错误处理不够丰富，也可以使用 github.com/pkg/errors 来处理错误</p> <p>此包常用的方法有</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 生成新的错误，同样会附加堆栈信息</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span>
<span class="token comment">// 只附加新的消息</span>
<span class="token keyword">func</span> <span class="token function">WithMessage</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">,</span>message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token comment">// 只附加堆栈信息</span>
<span class="token keyword">func</span> <span class="token function">WithStack</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token builtin">error</span>
<span class="token comment">// 附加信息 + 堆栈信息(就是一大堆的各种文件的堆栈调用过程的详细信息)</span>
<span class="token keyword">func</span> <span class="token function">Wrapf</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">,</span>format <span class="token builtin">string</span><span class="token punctuation">,</span>args<span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token comment">// 获取最根本的错误（错误链的最底层）</span>
<span class="token keyword">func</span> <span class="token function">Cause</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre></div><p>例如：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	err <span class="token operator">:=</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// %+v 是 pkg/errors 包提供的格式化输出格式，输出错误堆栈</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%+v&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span><span class="token string">&quot;open error&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在使用这个 pkg/errors 包的时候要注意一件事，因为 wrap 可以包装堆栈向上输出，如果你调用的第三方库使用了 wrap，你再次使用 wrap，那么就会出现两堆相同的堆栈信息，这造成了极大的冗余。</p> <p>所以，</p> <ul><li>在提供多人使用的三方库的时候不要使用 wrap，只有逻辑代码的时候使用 wrap 的功能</li> <li>遇到一个错误不打算处理，那么要带上足够多的信息再向上抛出</li> <li>一旦错误处理完成之后就没有错误了，不再需要把错误继续网上抛，返回 nil 即可</li></ul> <p>所以我们使用 pkg/errors 包将上面的分层写法做一个更完善的改进：</p> <p>dao 层生产错误</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// a</span>
<span class="token keyword">func</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// 返回此处的错误堆栈</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span><span class="token string">&quot;error:&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre></div><p>service 追加错误</p> <div class="language-go extra-class"><pre class="language-go"><code>err <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// 不返回堆栈了，仅仅添加错误</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">WithMessage</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span><span class="token string">&quot;getName error&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>controller 打印错误</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span> err<span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token comment">// 添加日志</span>
	<span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="errgroup-的使用技巧">errgroup 的使用技巧</h3> <p>errgroup 的使用方法是 golang.org/x/sync/errgroup</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;golang.org/x/sync/errgroup&quot;</span>
<span class="token punctuation">)</span>


<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	g<span class="token punctuation">,</span> ctx <span class="token operator">:=</span> errgroup<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// 启动一个 goroutine去处理错误</span>
	g<span class="token punctuation">.</span><span class="token function">Go</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error1&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	g<span class="token punctuation">.</span><span class="token function">Go</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error2&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// 类似 waitgroup 的 wait 方法</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> g<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="错误处理相关技巧">错误处理相关技巧</h2> <p>这里会介绍在实战过程中用到的诸多技巧</p> <h3 id="使用-errors-new-时要写清楚包名">使用 errors.New() 时要写清楚包名</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> age

ErrMyAge <span class="token operator">:=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;age: ErrMyAge is error&quot;</span><span class="token punctuation">)</span>
ErrMyAddress <span class="token operator">:=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;age: ErrMyAddress is error&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="使用-error-处理一般错误-使用-panic-处理严重错误-异常">使用 error 处理一般错误，使用 panic 处理严重错误 (异常)</h3> <p>使用这种模型就避免了类似 Java 那种所有错误都一样的行为，Java 的使用 try-catch 的方式导致任何错误都是一个方式去处理，非常有可能让程序员忽略错误的处理</p> <p>然而 go 不同，<strong>错误</strong>使用 error，<strong>异常</strong>使用 panic 的方式去处理。</p> <ul><li>错误：error</li> <li>异常：panic</li></ul> <p>假设我们在代码中使用了 panic，通常来说，为了代码的健壮性还是会使用 defer 函数去运行一个 recover() 的，程序的存活比啥都重要。</p> <h3 id="基础库-应该避免使用-error-types">基础库，应该避免使用 error types</h3> <p>因为这种写法容易造成代码的耦合，尤其是在我们写的基础库中，非常容易造成改动代码来引入的不健壮性。</p> <p>使用自定义的 error type</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// 为了额外增加更多的错误信息，字段需大写</span>
<span class="token keyword">type</span> ErrMyAge <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	EV <span class="token builtin">string</span>
	MErr <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>ErrMyAge<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;age: %s&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>EV<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	err <span class="token operator">:=</span> <span class="token operator">&amp;</span>ErrMyAge<span class="token punctuation">{</span><span class="token string">&quot;err age is hi&quot;</span><span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用 errors.New() 哨兵错误模式：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 我方代码</span>
ErrAge <span class="token operator">:=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;age: ErrAge is error&quot;</span><span class="token punctuation">)</span>
ErrAddress <span class="token operator">:=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;age: ErrAddress is error&quot;</span><span class="token punctuation">)</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">// 使用者</span>

<span class="token keyword">import</span><span class="token punctuation">(</span>
	<span class="token string">&quot;github.com/shgopher/age&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// 带来了耦合</span>
		<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> age<span class="token punctuation">.</span>ErrAge<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// 处理</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实际上他们都是 error types，只不过前者比后者增加了很多额外的信息，但是相同点是，他们都造成了耦合</p> <p>如果别人使用了这个基础库，那么势必这些错误就会跟使用者的代码耦合，我们改动了代码，第三方的代码就会因此受到影响。</p> <p>因此，在对外暴露的基础包中，我们应尽量减少定义哨兵错误 (上述定义方法被称之为哨兵模式的错误)</p> <p>上述提供的哨兵模式是透明的错误导出机制，所以容易造成耦合</p> <p>我们可以提供不透明的机制，不导出透明的错误类型，仅仅让用户判断是否等于 nil，就可以防止耦合的存在</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">&quot;github.com/shgopher/age&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token keyword">if</span> err<span class="token operator">:=</span> age<span class="token punctuation">.</span><span class="token function">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>
</code></pre></div><p>这也是大多数程序应该提供的模式，不对外暴露，避免了耦合</p> <p>那么这种方法的缺陷也很明显了，就是无法获取更多的错误信息，理论上来说，我们也没必要获取那么多错误信息，但是如果真的要获取错误信息了，该如何去做呢？</p> <p>我们可以向外暴露一些动作，只暴露行为：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> mage <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过一个对外暴露的函数可以对外输出行为</span>
<span class="token comment">// 并且还不用暴露出具体的对象</span>
<span class="token keyword">func</span> <span class="token function">IsMage</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token builtin">bool</span> <span class="token punctuation">{</span>
	 a<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>mage<span class="token punctuation">)</span>
	 <span class="token keyword">return</span> ok <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span><span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="优化不必要的代码让程序变得更简洁">优化不必要的代码让程序变得更简洁</h3> <p>方法一将大函数变小函数，通过封装函数的方法从视觉上降低 if err 的影响。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 改造之前</span>

<span class="token keyword">func</span> <span class="token function">OpenFile</span><span class="token punctuation">(</span>src <span class="token punctuation">,</span>dst <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> r<span class="token punctuation">,</span>err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> w<span class="token punctuation">,</span>err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span><span class="token function">Cloase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span>err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> err<span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>

		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将前面两个操作封装成一个函数</span>

<span class="token keyword">func</span> <span class="token function">OpenD</span><span class="token punctuation">(</span>src dst <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">,</span><span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> r <span class="token punctuation">,</span>w <span class="token operator">*</span>os<span class="token punctuation">.</span>File 
	<span class="token keyword">var</span> err <span class="token builtin">error</span>

	<span class="token keyword">if</span> r<span class="token punctuation">,</span>err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span> err<span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">,</span>err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> w<span class="token punctuation">,</span>err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span> err<span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span><span class="token boolean">nil</span><span class="token punctuation">,</span>err
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> r<span class="token punctuation">,</span>w<span class="token punctuation">,</span>err
<span class="token punctuation">}</span>
<span class="token comment">// 主函数就只有一个 if err 了</span>
<span class="token keyword">func</span> <span class="token function">OpenFile</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span>dst <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span>
	<span class="token keyword">var</span> r<span class="token punctuation">,</span> w <span class="token operator">*</span>os<span class="token punctuation">.</span>File
	<span class="token keyword">if</span> r<span class="token punctuation">,</span>w<span class="token punctuation">,</span>err <span class="token operator">=</span> <span class="token function">OpenD</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span> err<span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		r<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		w<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span>err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> err<span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>方法二将代码中不必要的成分删除，来保证代码的简洁</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 改造前</span>
<span class="token keyword">func</span> <span class="token function">AuthticateRequest</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Request<span class="token punctuation">)</span><span class="token builtin">error</span><span class="token punctuation">{</span>
	err <span class="token operator">:=</span> <span class="token function">authticate</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// 实际上 authticate 只返回一个 error 类型的接口，根本不需要判断</span>
<span class="token keyword">func</span> <span class="token function">AuthticateRequest</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Request<span class="token punctuation">)</span><span class="token builtin">error</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">authticate</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>方法三使用更加合适的方法</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 我们要逐行去读取数据</span>

<span class="token comment">// 改造前</span>
<span class="token keyword">func</span> <span class="token function">Countlines</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span><span class="token punctuation">(</span>
		br <span class="token operator">=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
		line <span class="token builtin">int</span>
		err <span class="token builtin">error</span>
	<span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span>err <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">readline</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span>
		line <span class="token operator">++</span> 
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span>err
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> lines<span class="token punctuation">,</span><span class="token boolean">nil</span>
		
<span class="token punctuation">}</span>

<span class="token comment">// 代码看起来也是很合理的样子，也很简洁，但是，我们其实用的函数不是特别的合适</span>

<span class="token comment">//其实这里使用 scan 更加合适，代码量更加精简，并且结构异常舒服</span>
<span class="token keyword">func</span> <span class="token function">Countlines</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	
	sc <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewScanner</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	lines <span class="token operator">:=</span> <span class="token number">0</span>

	<span class="token keyword">for</span> sc<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		lines<span class="token operator">++</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">return</span> lines<span class="token punctuation">,</span> sc<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="错误应该只处理一次">错误应该只处理一次</h3> <p>我们有日志系统，有些时候我们发现一个错误，然后打了一个日志，然后又把错误给 return 了，实际上这与 go 语言哲学中说的错误只处理一次相违背</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// ❌</span>
<span class="token keyword">func</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span><span class="token punctuation">{</span>
	 <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;./a&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span>  err<span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Prinln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// ✅</span>
<span class="token keyword">func</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">error</span><span class="token punctuation">{</span>
	 <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;./a&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span>  err<span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span><span class="token string">&quot;open error&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>正确的处理方法是错误只处理一次，那么在什么时候处理呢？</p> <p>上文提到了多层的架构设计，我们在底层 (带有堆栈的错误向上抛出) 和中层 (仅仅附加信息再次向上抛出) 仅仅是向上抛出，并不需要将错误记录在日志中，在应用层才需要去使用日志记录错误，日志记录完错误以后，也不需要再向上抛出错误了 (最顶端了) 完全满足 “只处理一次错误” 的要求。</p> <h2 id="业务-code-码的设置">业务 code 码的设置</h2> <p>常见的 http 错误码数量较少，比如常见的只有例如 404 301 302 200 503 等，绝对数量还是较少，无法去表达业务上的错误，因此我们需要设置一套能表达具体生产业务的 code 码。</p> <p>为了保证服务端的安全，我们设置的 code 码应该设置两套数据，一套显示给客户端，一套自用，以此来保证服务端的绝对安全。</p> <p>有三种设计业务 code 码的方式：</p> <h3 id="一律返回-http-status-200-具体-code-码单独设置">一律返回 http status 200，具体 code 码单独设置</h3> <p>例如</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;error&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Syntax error \&quot;Field picture specified more than once. This is only possible before version 2.1\&quot; at character 23: id,name,picture,picture&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;OAuthException&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">2500</span><span class="token punctuation">,</span>
    <span class="token property">&quot;fbtrace_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xxxxxxxxxxx&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>http status code 通通 200</li> <li>code 2500，才是真实的面向客户端的 code 码</li></ul> <p>使用这种方法的一大缺陷就是必须解析 body 内容才能发现具体的错误业务码，很多场景我们仅仅需要知道返回的是成功或者错误，并不需要知晓具体的业务码，这是这种方式的一大弊端。</p> <h3 id="使用合适的-http-status-code-简单的信息以及业务错误代码">使用合适的 http status code + 简单的信息以及业务错误代码</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>HTTP/1.1 <span class="token number">400</span> Bad Request
x-connection-hash: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
set-cookie: <span class="token assign-left variable">guest_id</span><span class="token operator">=</span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Date: Thu, 01 Jun <span class="token number">2017</span> 03:04:23 GMT
Content-Length: <span class="token number">62</span>
x-response-time: <span class="token number">5</span>
strict-transport-security: max-age<span class="token operator">=</span><span class="token number">631138519</span>
Connection: keep-alive
Content-Type: application/json<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
Server: tsa_b

<span class="token comment"># 注意这里：仅仅返回简单的错误信息</span>
<span class="token punctuation">{</span><span class="token string">&quot;errors&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;code&quot;</span>:215,<span class="token string">&quot;message&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Bad Authentication data.&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div><p>这种方案也是大多数公司采纳的方案，使用具体的 http status code 可以知晓大概的业务类型，是错误还是正常运行，然后使用简单的错误信息和业务错误代码去定位具体的错误</p> <p>如果业务不是特别复杂，使用这种方式即可</p> <h3 id="使用合适的-http-status-code-非常详细的业务错误代码以及信息">使用合适的 http status code + 非常详细的业务错误代码以及信息</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>HTTP/1.1 <span class="token number">400</span>
Date: Thu, 01 Jun <span class="token number">2017</span> 03:40:55 GMT
Content-Length: <span class="token number">276</span>
Connection: keep-alive
Content-Type: application/json<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
Server: Microsoft-IIS/10.0
X-Content-Type-Options: nosniff

<span class="token punctuation">{</span><span class="token string">&quot;SearchResponse&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;Version&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2.2&quot;</span>,<span class="token string">&quot;Query&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;SearchTerms&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;api error codes&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;Errors&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;Code&quot;</span>:1001,<span class="token string">&quot;Message&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Required parameter is missing.&quot;</span>,<span class="token string">&quot;Parameter&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;SearchRequest.AppId&quot;</span>,<span class="token string">&quot;HelpUrl&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;http<span class="token entity" title="\u003a">\u003a</span><span class="token entity" title="\u002f">\u002f</span><span class="token entity" title="\u002f">\u002f</span>msdn.microsoft.com<span class="token entity" title="\u002f">\u002f</span>en-us<span class="token entity" title="\u002f">\u002f</span>library<span class="token entity" title="\u002f">\u002f</span>dd251042.aspx&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>当业务逻辑稍微复杂一些，并且需要极其精准和快速的定位错误时，就需要在返回的 body 中去设置非常详细的错误信息</p> <p><strong>综上所述：</strong></p> <ul><li>使用正确的 http status code 让业务的第一步变得更加直观</li> <li>区别于 http status code，具体业务的 code 码会更加丰富</li> <li>返回尽可能详细的错误，有助于复杂逻辑的快速错误定位</li> <li>直接返回给客户的错误代码不应该包括敏感信息，敏感信息的 code 码仅供内部使用</li> <li>错误信息要求规范，简洁以及有用</li></ul> <h3 id="业务-code-码的具体设计">业务 code 码的具体设计</h3> <p>引入业务 code 码的核心原因就是 http status code 太少，以及他们并不能跟具体业务挂钩。</p> <p>当我们设置好良好又详细的 code 码时，我们就可以快速定位业务代码，以及可以快速知晓发生错误的等级模块，具体信息等</p> <p>下面给出具体的设计思路：<strong>纯数字表达，不同的数字段表达不同的模块不同的业务</strong></p> <p>例如 100101</p> <ul><li>10：表示某个服务</li> <li>01：表示某个服务下的模块</li> <li>01：模块下的错误码</li></ul> <p>10 服务 01 模块 01 错误，--- 服务 10 数据库模块未找到记录错误</p> <p>一共最多有 100 个服务，每个服务最多有 100 个模块，每个模块最多有 100 个错误，如果某些模块 100 个都不够用，那怎么这个模块有必要去拆分一下了。</p> <h3 id="如何设置-http-status-code">如何设置 http status code</h3> <ul><li><code>1xx</code>：请求已接收，继续处理</li> <li><code>2xx</code>：成功处理了请求</li> <li><code>3xx</code>：请求被重定向</li> <li><code>4xx</code>：请求错误</li> <li><code>5xx</code>：服务器错误</li></ul> <p>由于 http status code 相对数量也不算太少，如果每一个都利用上，难免会增加复杂度，建议仅使用基本的几个即可</p> <ul><li>200 - 表示请求成功执行。</li> <li>400 - 表示客户端出问题。</li> <li>500 - 表示服务端出问题。</li></ul> <p>如果上述的感觉太少，再增加下面几个也可以</p> <ul><li>401 - 表示认证失败。</li> <li>403 - 表示授权失败。</li> <li>404 - 表示资源找不到，这里的资源可以是 URL 或者 RESTful 资源。</li></ul> <p>将 http status code 控制在<strong>个位数</strong>，有利于后端的逻辑代码简洁性，比如 301 302 确实是代表不同的含义，<strong>前端或许可以设置丰富的 http status code，因为浏览器会进行相关的具体操作，但是后端返回给前端的 http status code 并没有任何的操作，使用过多只会增加复杂度。</strong></p> <h2 id="设计一个生产级的错误包">设计一个生产级的错误包</h2> <h3 id="生产级的错误包需要的功能">生产级的错误包需要的功能</h3> <ol><li>支持错误堆栈</li></ol> <div class="language-go extra-class"><pre class="language-go"><code><span class="token number">2021</span><span class="token operator">/</span><span class="token number">07</span><span class="token operator">/</span><span class="token number">02</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">03</span> call <span class="token keyword">func</span> got failed<span class="token punctuation">:</span> <span class="token keyword">func</span> called <span class="token builtin">error</span>

main<span class="token punctuation">.</span>funcB <span class="token operator">/</span>home<span class="token operator">/</span>colin<span class="token operator">/</span>workspace<span class="token operator">/</span>golang<span class="token operator">/</span>src<span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>marmotedu<span class="token operator">/</span>gopractise<span class="token operator">-</span>demo<span class="token operator">/</span>errors<span class="token operator">/</span>good<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">27</span>
main<span class="token punctuation">.</span>funcA <span class="token operator">/</span>home<span class="token operator">/</span>colin<span class="token operator">/</span>workspace<span class="token operator">/</span>golang<span class="token operator">/</span>src<span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>marmotedu<span class="token operator">/</span>gopractise<span class="token operator">-</span>demo<span class="token operator">/</span>errors<span class="token operator">/</span>good<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">19</span>
main<span class="token punctuation">.</span>main <span class="token operator">/</span>home<span class="token operator">/</span>colin<span class="token operator">/</span>workspace<span class="token operator">/</span>golang<span class="token operator">/</span>src<span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>marmotedu<span class="token operator">/</span>gopractise<span class="token operator">-</span>demo<span class="token operator">/</span>errors<span class="token operator">/</span>good<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">10</span>
runtime<span class="token punctuation">.</span>main <span class="token operator">/</span>home<span class="token operator">/</span>colin<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>go1<span class="token punctuation">.</span><span class="token number">16.2</span><span class="token operator">/</span>src<span class="token operator">/</span>runtime<span class="token operator">/</span>proc<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span>225runtime<span class="token punctuation">.</span>goexit <span class="token operator">/</span>home<span class="token operator">/</span>colin<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>go1<span class="token punctuation">.</span><span class="token number">16.2</span><span class="token operator">/</span>src<span class="token operator">/</span>runtime<span class="token operator">/</span>asm_amd64<span class="token punctuation">.</span>s<span class="token punctuation">:</span><span class="token number">1371</span>
exit status <span class="token number">1</span>
</code></pre></div><p>拥有错误的堆栈，我们才能定位错误的根源。</p> <ol start="2"><li><p>支持打印不同的格式比如 %s %w %d</p></li> <li><p>支持 Wrap() Unwrap() 的功能，就是错误的嵌套和反嵌套</p></li> <li><p>错误包要支持 Is() 和 As() 方法，这主要是因为有错误的嵌套，所以无法再使用接口相比较的方式进行判断接口类型是否相等 (类型相同，值相同)</p></li> <li><p>要支持格式化和非格式化的创建方式</p></li></ol> <div class="language-go extra-class"><pre class="language-go"><code>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;err&quot;</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%w&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
</code></pre></div><h3 id="具体实现">具体实现</h3> <p>从 github.com/pkg/errors 包中改造即可。</p> <p>增加以下字段的结构体就可以满足上面的需求</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> withCode <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	err   <span class="token builtin">error</span>
	code  <span class="token builtin">int</span>
	cause <span class="token builtin">error</span>
	<span class="token operator">*</span>stack
<span class="token punctuation">}</span>
</code></pre></div><h2 id="issues">issues</h2> <p><code>问题一：</code> <strong>请说出下列代码的执行输出</strong>*</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hi1&quot;</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;oops&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// 这里的defer将不会进栈，所以也就不会执行了。</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hi2&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>答案是</p> <div class="language-go extra-class"><pre class="language-go"><code>hi1
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span>
oops
<span class="token builtin">panic</span><span class="token punctuation">:</span> oops

goroutine <span class="token number">1</span> <span class="token punctuation">[</span>running<span class="token punctuation">]</span><span class="token punctuation">:</span>
main<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">/</span>tmp<span class="token operator">/</span>sandbox1932632082<span class="token operator">/</span>prog<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">18</span> <span class="token operator">+</span><span class="token number">0xa7</span>

Program exited<span class="token punctuation">.</span>
</code></pre></div><p>解释：Panic，意味着恐慌，意思等于 return，所以 panic 下面的数据是无法执行的，defer 不同，他们是顺序的将这些 defer 函数装入函数内置的 defer 栈的，所以在 return 之后，defer 栈会执行，所以这里的 defer 1 2 3 可以执行，Panic 前面的 hi1 可以执行，但是 Panic 之后，相当于 return 后面的 hi2 就无法执行了。</p> <p><code>问题二：</code> <strong>看一段代码，分析答案</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Recovered in f&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;starting f&quot;</span><span class="token punctuation">)</span>
	<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;behind  g&quot;</span><span class="token punctuation">)</span> <span class="token comment">//会终止执行</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">g</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Defer in g&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Panicking!&quot;</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%v&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Printing in g&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token comment">//终止执行</span>
<span class="token punctuation">}</span>
</code></pre></div><p>答案是</p> <div class="language-js extra-class"><pre class="language-js"><code>starting f
panicking
Defer <span class="token keyword">in</span> g <span class="token number">2</span>
recoverd <span class="token keyword">in</span> f
</code></pre></div><p>解释一下，首先执行的是 f 函数的代码，然后开始执行 g，在 g 中遇到了 Panic，所以 panic 后面的 parinting in g 就无法执行了，所以执行了 defer in g
这个时候 f 中的 g(2) 后面的数据也无法执行了，因为整个 f 也陷入了恐慌，所以它只能 return 进入 defer 了，defer 中刚好有 recover，所以执行了 recover 信息后，就退出了函数。</p> <h2 id="参考资料">参考资料</h2> <ul><li>https://mp.weixin.qq.com/s/EvkMQCPwg-B0ffZonpwXodg</li> <li>https://mp.weixin.qq.com/s/D_CVrPzjP3O81EpFqLoynQ</li> <li>https://time.geekbang.org/column/article/391895</li> <li>极客时间《go 进阶训练营》</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/shgopher/GOFamily/edit/release/基础/错误处理/README.md" target="_blank" rel="noopener noreferrer">在GitHub中编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">1/5/2024, 2:50:37 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/GOFamily/assets/js/app.6dac5fbf.js" defer></script><script src="/GOFamily/assets/js/2.5c331e53.js" defer></script><script src="/GOFamily/assets/js/44.5dc33e34.js" defer></script>
  </body>
</html>
